<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Players page</title>
    <script type="text/javascript" src="js/d3.v7.min.js"></script>
    <script type="text/javascript" src="js/toolbox.js"></script>
    <script type="text/javascript" src="js/player_page.js"></script>

    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/player_page.css">

    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&" as="style" onload="this.onload=null;this.rel='stylesheet'">
</head>
<body onload="load_data()">
    <div class="page-wrapper players-view">
        <div class="choose-players">
            <menu>
                <div class="search-blob">
                    <div class="switch-search-mode">
                        <span class="material-symbols-outlined" onclick="switch_search_mode(this)">person</span>
                    </div>
                    <input type="text" id="search" placeholder="Search player..." onkeydown="if (event.key === 'Enter') filter_search(this.value)">
                    <span class="material-symbols-outlined" onclick="filter_search(this.parentNode.querySelector('input').value)">search</span>
                    <datalist id="search-list"></datalist>
                </div>
                <div class="filters">
                    <span class="material-symbols-outlined" onclick="show_filter_page()">filter_alt</span>
                    <div class="filter-options">
                        <div class="filter-option">
                            <label for="position">Position</label>
                            <select name="position" id="position" onchange="filter_position(this.value)">
                                <option value="all">All</option>
                                <option value="Goalkeeper">Goalkeeper</option>
                                <option value="Defender">Defender</option>
                                <option value="Midfielder">Midfielder</option>
                                <option value="Forward">Forward</option>
                            </select>
                        </div>

                        <div class="filter-option">
                            <label for="nationality">Nationality</label>
                            <select name="nationality" id="nationality-select" onchange="filter_national(this.value)">
                                <option value="all">All</option>
                                <!--  -->
                            </select>
                        </div>
                    </div>
                </div>
            </menu>
            

            <table class="players-table">
                <thead>
                    <tr>
                        <th width="38%" onclick="sort_table('club', this)" sort="club">
                            <div class="th-content">
                                Club 
                                <div class="sorting">
                                    <span class="material-symbols-outlined active">arrow_drop_up</span>
                                    <span class="material-symbols-outlined">arrow_drop_down</span>
                                </div>
                                <span>1</span>
                            </div>
                        </th>
                        <th width="43%" onclick="sort_table('player_name', this)" sort="player_name">
                            <div class="th-content">
                                Player
                                <div class="sorting">
                                    <span class="material-symbols-outlined active">arrow_drop_up</span>
                                    <span class="material-symbols-outlined active">arrow_drop_down</span>
                                </div>
                                <span></span>
                            </div>
                        </th>
                        <th width="5%" onclick="sort_table('age', this)" sort="age">
                            <div class="th-content">
                                Age
                                <div class="sorting">
                                    <span class="material-symbols-outlined active">arrow_drop_up</span>
                                    <span class="material-symbols-outlined active">arrow_drop_down</span>
                                </div>
                                <span></span>
                            </div>
                        </th>
                        <th width="12%" onclick="sort_table('score', this)" sort="score">
                            <div class="th-content">
                                Note
                                <div class="sorting">
                                    <span class="material-symbols-outlined">arrow_drop_up</span>
                                    <span class="material-symbols-outlined active">arrow_drop_down</span>
                                </div>
                                <span>3</span>
                            </div>
                        </th>
                        <th width="12%" onclick="sort_table('position', this)" sort="position">
                            <div class="th-content">
                                Position
                                <div class="sorting">
                                    <span class="material-symbols-outlined active">arrow_drop_up</span>
                                    <span class="material-symbols-outlined">arrow_drop_down</span>
                                </div>
                                <span>2</span>
                            </div>
                        </th>
                        <th width="2%" onclick="sort_table('nationality', this)" sort="nationality">
                            <div class="th-content">
                                Nationality
                                <div class="sorting">
                                    <span class="material-symbols-outlined active">arrow_drop_up</span>
                                    <span class="material-symbols-outlined active">arrow_drop_down</span>
                                </div>
                                <span></span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Players will be populated dynamically -->
                </tbody>
            </table>

            <div class="pagination" id="pagination"></div>
            <br/>
            <div class="players-tags"></div>
        </div>
        
        <div class="player-stats">
            <div class="spider-charts">
                <svg class="spider-chart" id='spider-chart-2021-2022'></svg>
                <svg class="spider-chart" id='spider-chart-2022-2023'></svg>
                <svg class="spider-chart" id='spider-chart-2023-2024'></svg>
            </div>
            <div class="players-card">
                <!-- populates by js -->
            </div>
        </div>

        <div class="distribution-charts"></div>
    </div>

    <script>
        const filter_page = document.querySelector('.filter-options');
        const filters = {
            position: null,
            nationality: null,
            player: null,
            club: null,
        }

        const sorts = {
            club: {index: 0, order: 'asc'},
            player_name: null,
            age: null,
            score: {index: 2, order: 'desc'},
            position: {index: 1, order: 'asc'},
            nationality: null,
        }

        const filter_button = document.querySelector('.filters span')

        let sort_index = 3

        let search_mode = 'player'

        function show_filter_page() {
            filter_page.classList.toggle('active');
        }

        // if we click out of filters, close it
        window.addEventListener('click', function(event) {
            if (!filter_page.contains(event.target) && !event.target.classList.contains('material-symbols-outlined')) {
                filter_page.classList.remove('active');
            }
        });

        function switch_search_mode(element) {
            // shield
            // emoji_events
            // group
            // sports
            // sports_soccer
            search_mode = element.textContent === 'person' ? 'club' : 'player'
            element.textContent = search_mode === 'player' ? 'person' : 'shield'
            document.querySelector('input#search').placeholder = `Search ${search_mode}...`
        }

        function filter_position(value) {
            filters.position = value == 'all' ? null : value
            filter()
            if (document.querySelectorAll('tr[is-visible="true"]').length === 0) {
                setTimeout(() => {
                    filter_button.classList.add('not-found')
                    setTimeout(() => {
                        filter_button.classList.remove('not-found')
                    }, 500)
                }, 100)
            } else {
                setTimeout(() => {
                    filter_button.classList.add('found')
                    setTimeout(() => {
                        filter_button.classList.remove('found')
                    }, 500)
                }, 100)
            }
        }

        function filter_national(value) {
            filters.nationality = value == 'all' ? null : value
            filter()

            if (document.querySelectorAll('tr[is-visible="true"]').length === 0) {
                setTimeout(() => {
                    filter_button.classList.add('not-found')
                    setTimeout(() => {
                        filter_button.classList.remove('not-found')
                    }, 500)
                }, 100)
            } else {
                setTimeout(() => {
                    filter_button.classList.add('found')
                    setTimeout(() => {
                        filter_button.classList.remove('found')
                    }, 500)
                }, 100)
            }
        }

        function filter_search(value) {
            value = value.trim()
            value = value.length > 0 ? value.toLowerCase() : null
            if (search_mode === 'player') {
                filters.player = value
            } else {
                filters.club = value
            }
            
            filter()

            // if we have a value tr[is-visible='true']
            if (document.querySelectorAll('tr[is-visible="true"]').length === 0) {
                search_blob = document.querySelector('.search-blob input')
                setTimeout(() => {
                    search_blob.classList.add('not-found')
                    setTimeout(() => {
                        search_blob.classList.remove('not-found')
                    }, 500)
                }, 100)
            } else {
                search_blob = document.querySelector('.search-blob input')
                setTimeout(() => {
                    search_blob.classList.add('found')
                    setTimeout(() => {
                        search_blob.classList.remove('found')
                    }, 500)
                }, 100)
            }
        }

        function filter() {
            // table_filter(search, positions, clubs, nationaly)
            table_filter(filters.player, filters.position, filters.club, filters.nationality)
        }

        function sort_table(key, th) {
            if (sorts[key] === null) {
                sorts[key] = {index: sort_index, order: 'asc'}
                sort_index++
                th.querySelector('.sorting').children[0].classList.add('active')
                th.querySelector('.sorting').children[1].classList.remove('active')
                th.querySelector(' .th-content > span').textContent = sort_index
            } else if (sorts[key].order === 'asc') {
                sorts[key].order = 'desc'
                th.querySelector('.sorting').children[0].classList.remove('active')
                th.querySelector('.sorting').children[1].classList.add('active')
            } else {
                remove_index = sorts[key].index
                sorts[key] = null
                if (remove_index != sort_index) {
                    Object.keys(sorts).forEach(k => {
                        if (sorts[k] !== null && sorts[k].index > remove_index) {
                            sorts[k].index -= 1
                            th.parentNode.querySelector(`th[sort='${k}'] .th-content > span`).textContent = sorts[k].index + 1
                        }
                    })
                }
                sort_index--
                th.querySelector('.sorting').children[0].classList.add('active')
                th.querySelector('.sorting').children[1].classList.add('active')
                th.querySelector(' .th-content > span').textContent = ''
            }
            sort_player_table(sorts['club'], sorts['player_name'], sorts['age'], sorts['score'], sorts['position'], sorts['nationality'])
        }

        // when document has attribute 'ready'
        document.addEventListener('ready', function() {
            sort_player_table(sorts['club'], sorts['player_name'], sorts['age'], sorts['score'], sorts['position'], sorts['nationality'], true)
        })
    </script>
</body>
</html>
